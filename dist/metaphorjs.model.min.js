(function(){var t=function(b){return"function"==typeof b},ma=Object.prototype.toString,W=function(){var b={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(a){if(!a){if(null===a)return 6;if(void 0===a)return 7}var c=b[ma.call(a)];return void 0===c?-1:1==c&&isNaN(a)?8:c}}(),u=function(b){return"string"==typeof b||b===""+b},N=function(b){if(null===b||"object"!=typeof b)return!1;
b=W(b);return 2<b||-1==b},aa=function(b,a){var c={};b||(b="undefined"!=typeof global?global:window);this.register=function(d,e){var f;f=d;var g=f.split("."),k,z=g.pop();k=g.join(".");var m=g.length,B,v=b;if(c[k])f=[c[k],z,f];else{if(0<m)for(k=0;k<m;k++){B=g[k];if(a&&0==k)if(B==a){v=b;continue}else f=a+"."+f;void 0===v[B]&&(v[B]={});v=v[B]}else a&&(f=a+"."+f);f=[v,z,f]}g=f[0];z=f[1];N(g)&&void 0===g[z]&&(g[z]=e,c[f[2]]=e);return e};this.exists=function(a){return void 0!==c[a]};this.get=function(d,
e){if(void 0!==c[d])return c[d];if(a&&void 0!==c[a+"."+d])return c[a+"."+d];if(!e){var f=d.split("."),g,k=f.length,z,m=b;for(g=0;g<k;g++)if(z=f[g],a&&0==g&&z==a)m=b;else{if(void 0===m[z])return;m=m[z]}m&&(c[d]=m);return m}};this.add=function(b,e){a&&0!==b.indexOf(a)&&(b=a+"."+b);void 0===c[b]&&(c[b]=e);return e};this.remove=function(a){delete c[a]}};aa.prototype={register:null,exists:null,get:null,add:null,remove:null};var U=Array.prototype.slice,ga=function(b,a,c,d){setTimeout(function(){b.apply(a,
c||[])},d||0)},K=function(b){var a=b.stack||Error().stack;if("undefined"!=typeof console&&console.log)ga(function(){console.log(b);a&&console.log(a)});else throw b;},h=function(){},J=function(b){b||(b=new aa);var a=function(){this.supr&&this.supr!==h&&this.supr.apply(this,arguments)},c=function(a,c){return f(function(){},a,c)},d=function(a,c,b){return function(){var d,e=this.supr;this.supr=a.prototype[c]||("__construct"==c?a:h)||h;d=b.apply(this,arguments);this.supr=e;return d}},e=function(a,c,b){for(var e in c)c.hasOwnProperty(e)&&
(a[e]=!t(c[e])||!t(b.prototype[e])&&b.prototype[e]?c[e]:d(b,e,c[e]))},f=function(c,b,d){var f=function(){};f.prototype=c.prototype;f=new f;b.__construct=d||a;var g=function(){this.__construct.apply(this,arguments);this.initialize&&this.initialize.apply(this,arguments)};e(f,b,c);f.constructor=g;g.prototype=f;g.prototype.getClass=function(){return g.__class};g.prototype.getParentClass=function(){return g.__parentClass};g.__instantiate=function(a){return function(){var c=function(){},b;c.prototype=a.prototype;
c=new c;b=a.prototype.constructor.apply(c,arguments);return N(b)?b:c}}(g);return g},g=function(a,d,e,g,v,l){null===a&&(a="");t(a)?(v=e,u(d)?(v=g,g=e):(g=d,e=a,d=null),a=null):u(a)||(v=d,g=a,a=e=d=null);u(d)||t(d)||(v=g,g=e,e=d,d=null);t(e)||(v=g,g=e,e=null);g=g||{};var F=d&&u(d)?b.get(d):d;if(d&&!F)throw Error(d+" not found");d=F?f(F,g,e):c(g,e);d.__isMetaphorClass=!0;d.__parent=F;d.__parentClass=F?F.__class:null;d.__class=a;if(v)for(var h in v)v.hasOwnProperty(h)&&(d[h]=v[h]);a&&(l?b.add(a,d):b.register(a,
d));v&&v.alias&&b.add(v.alias,d);return d};this.factory=function(a){var c=b.get(a),d=U.call(arguments,1);if(!c)throw Error(a+" not found");return c.__instantiate.apply(this,d)};this.isSubclassOf=function(a,c){var d=a,e=b.get;u(c)||(c=c.getClass?c.getClass():c.prototype.constructor.__class);for(u(a)&&(d=e(a));d;){if(d.prototype.constructor.__class==c)return!0;d&&(d=d.getParentClass?e(d.getParentClass()):d.__parent)}return!1};this.isInstanceOf=function(a,c){var d=u(c)?b.get(c):c;return d?a instanceof
d:!1};this.define=g;this.defineCache=function(a,c,d,b,e){return g(a,c,d,b,e,!0)};this.extend=function(a,c,d,b){return g(null,a,c,d,b)}};J.prototype={factory:null,isSubclassOf:null,isInstanceOf:null,define:null,defineCache:null,extend:null};var ba={lib:{},cmp:{},view:{}},na=new aa(ba,"MetaphorJs"),J=new J(na),G=J.define,l=Function.prototype.bind?function(b,a){return b.bind(a)}:function(b,a){return function(){return b.apply(a,arguments)}},X=function(b){return"object"==typeof b&&3===W(b)&&!b.nodeType},
ca=function(b){return!0===b||!1===b},p=function(){return function a(){var c=!1,d=!1,e=U.call(arguments),f=e.shift(),g,k,z;ca(e[e.length-1])&&(c=e.pop());ca(e[e.length-1])&&(d=c,c=e.pop());for(;e.length;)if(g=e.shift())for(k in g)if(g.hasOwnProperty(k)&&void 0!==(z=g[k]))if(d)if(f[k]&&X(f[k])&&X(z))a(f[k],z,c,d);else{if(!0===c||void 0==f[k])X(z)?(f[k]={},a(f[k],z,c,!0)):f[k]=z}else if(!0===c||void 0==f[k])f[k]=z;return f}}(),ha=function(){return String.prototype.trim?function(b){return u(b)?b.trim():
b}:function(b){return u(b)?b.replace(/^\s\s*/,"").replace(/\s\s*$/,""):b}}(),oa=function(){return"undefined"!=typeof JSON?function(b){return JSON.parse(b)}:function(b){return(new Function("return "+b))()}}(),ia=function(b,a){var c,d;if(!b||!u(b))return null;try{d=new DOMParser,c=d.parseFromString(b,a||"text/xml")}catch(e){c=void 0}if(!c||c.getElementsByTagName("parsererror").length)throw"Invalid XML: "+b;return c},da=function(b){if(b&&void 0!=!b.length&&b!==""+b){for(var a=[],c=-1,d=b.length>>>0;++c!==
d;a[c]=b[c]);return a}return b?[b]:[]},ka=function(){var b=/^[\w[:#.][\w\]*^|=!]*$/,a=/=([^\]]+)/,c=/ *, */,d=/(\([^)]*)\+/,e=/(\[[^\]]+)~/,f=/(~|>|\+)/,g=/ +/,k=/([^[:.#]+)?(?:#([^[:.#]+))?(?:\.([^[:.]+))?(?:\[([^!&^*|$[:=]+)([!$^*|&]?=)?([^:\]]+)?\])?(?::([^(]+)(?:\(([^)]+)\))?)?/,z=/(?:(-?\d*)n)?(?:(%|-)(\d*))?/,m=/\D/,B=/[^(]*\(([^)]*)\)/,v=/\(.*/,l=/\[([^!~^*|$ [:=]+)([$^*|]?=)?([^ :\]]+)?\]/,F=document,u=!!F.getElementsByClassName,t=!!F.querySelectorAll,y={"first-child":function(a){return a.parentNode.getElementsByTagName("*")[0]!==
a},"last-child":function(a){for(;(a=a.nextSibling)&&1!=a.nodeType;);return!!a},root:function(a){return"html"!==a.nodeName.toLowerCase()},"nth-child":function(a,c){var d=a.nodeIndex||0,b=c[3]=c[3]?("%"===c[2]?-1:1)*c[3]:0,e=c[1];if(d)return!((d+b)%e);var w=a.parentNode.firstChild;d++;do if(1==w.nodeType&&(w.nodeIndex=++d)&&a===w&&(d+b)%e)return 0;while(w=w.nextSibling);return 1},"nth-last-child":function(a,c){var d=a.nodeIndexLast||0,b=c[3]?("%"===c[2]?-1:1)*c[3]:0,e=c[1];if(d)return!((d+b)%e);var w=
a.parentNode.lastChild;d++;do if(1==w.nodeType&&(w.nodeLastIndex=d++)&&a===w&&(d+b)%e)return 0;while(w=w.previousSibling);return 1},empty:function(a){return!!a.firstChild},parent:function(a){return!a.firstChild},"only-child":function(a){return 1!=a.parentNode.getElementsByTagName("*").length},checked:function(a){return!a.checked},lang:function(a,c){return a.lang!==c&&F.documentElement.lang!==c},enabled:function(a){return a.disabled||"hidden"===a.type},disabled:function(a){return!a.disabled},selected:function(a){return!a.selected}},
h={},p=function(a){return h[a]||(h[a]=new RegExp("(^| +)"+a+"($| +)"))},D={"":function(a,c){return null!==a.getAttribute(c)},"=":function(a,c,d){var b;return(b=a.getAttribute(c))&&b===d},"&=":function(a,c,d){var b;return(b=a.getAttribute(c))&&p(d).test(b)},"^=":function(a,c,d){var b;return(b=a.getAttribute(c)+"")&&!b.indexOf(d)},"$=":function(a,c,d){var b;return(b=a.getAttribute(c)+"")&&b.indexOf(d)==b.length-d.length},"*=":function(a,c,d){var b;return(b=a.getAttribute(c)+"")&&-1!=b.indexOf(d)},"|=":function(a,
c,d){var b;return(b=a.getAttribute(c)+"")&&(b===d||!!b.indexOf(d+"-"))},"!=":function(a,c,d){var b;return!(b=a.getAttribute(c))||!p(d).test(b)}},w=function(w,C){C=C||F;var q=[],x=null,h,p,L,n,M,E,H;if(t)try{q=da(C.querySelectorAll(w.replace(a,'="$1"')))}catch(J){x=!0}if(!t||x)if(b.test(w))switch(x=0,w.charAt(0)){case "#":x=w.slice(1);q=F.getElementById(x);q.id!==x&&(q=F.all[x]);q=q?[q]:[];break;case ".":h=w.slice(1);if(u)q=da((q=C.getElementsByClassName(h)).length?q:[]);else{h=" "+h+" ";p=C.getElementsByTagName("*");
for(L=0;n=p[L++];)-1!=(" "+n.className+" ").indexOf(h)&&(q[x++]=n);q=x?q:[]}break;case ":":p=C.getElementsByTagName("*");L=0;M=w.replace(B,"$1");for(E=w.replace(v,"");n=p[L++];)y[E]&&!y[E](n,M)&&(q[x++]=n);q=x?q:[];break;case "[":p=C.getElementsByTagName("*");L=0;n=l.exec(w);h=n[1];H=n[2]||"";for(M=n[3];n=p[L++];)D[H]&&(D[H](n,h,M)||"class"===h&&D[H](n,"className",M))&&(q[x++]=n);q=x?q:[];break;default:q=da((q=C.getElementsByTagName(w)).length?q:[])}else{for(var A=w.split(c),I=A.length-1,V=!!I,S,
T,s,N,O,P,Q,R,U,r,K,G;x=A[I--];){T=(S=x.replace(d,"$1%").replace(e,"$1&").replace(f," $1 ").split(g)).length;L=0;N=" ";for(p=[C];s=S[L++];)if(" "!==s&&">"!==s&&"~"!==s&&"+"!==s&&p){s=s.match(k);O=s[1]||"*";P=s[2];Q=s[3]?" "+s[3]+" ":"";h=s[4];H=s[5]||"";E=s[7];M="nth-child"===E||"nth-last-child"===E?z.exec("even"===s[8]&&"2n"||"odd"===s[8]&&"2n%1"||!m.test(s[8])&&"0n%"+s[8]||s[8]):s[8];R=[];x=U=0;for(K=L==T;r=p[U++];)switch(N){case " ":G=r.getElementsByTagName(O);for(r=0;n=G[r++];)P&&n.id!==P||Q&&
-1==(" "+n.className+" ").indexOf(Q)||!(!h||D[H]&&(D[H](n,h,s[6])||"class"===h&&D[H](n,"className",s[6])))||n.yeasss||(y[E]?y[E](n,M):E)||(K&&(n.yeasss=1),R[x++]=n);break;case "~":for(O=O.toLowerCase();(r=r.nextSibling)&&!r.yeasss;)1!=r.nodeType||"*"!==O&&r.nodeName.toLowerCase()!==O||P&&r.id!==P||Q&&-1==(" "+r.className+" ").indexOf(Q)||!(!h||D[H]&&(D[H](n,h,s[6])||"class"===h&&D[H](n,"className",s[6])))||r.yeasss||(y[E]?y[E](r,M):E)||(K&&(r.yeasss=1),R[x++]=r);break;case "+":for(;(r=r.nextSibling)&&
1!=r.nodeType;);!r||r.nodeName.toLowerCase()!==O.toLowerCase()&&"*"!==O||P&&r.id!==P||Q&&-1==(" "+n.className+" ").indexOf(Q)||!(!h||D[H]&&(D[H](n,h,s[6])||"class"===h&&D[H](n,"className",s[6])))||r.yeasss||(y[E]?y[E](r,M):E)||(K&&(r.yeasss=1),R[x++]=r);break;case ">":for(G=r.getElementsByTagName(O),L=0;n=G[L++];)n.parentNode!==r||P&&n.id!==P||Q&&-1==(" "+n.className+" ").indexOf(Q)||!(!h||D[H]&&(D[H](n,h,s[6])||"class"===h&&D[H](n,"className",s[6])))||n.yeasss||(y[E]?y[E](n,M):E)||(K&&(n.yeasss=
1),R[x++]=n)}p=R}else N=s;if(V){if(!p.concat){R=[];for(r=0;n=p[r];)R[r++]=n;p=R}q=p.concat(1==q.length?q[0]:q)}else q=p}for(x=q.length;x--;)q[x].yeasss=q[x].nodeIndex=q[x].nodeIndexLast=null}return q};w.is=function(a,c){var d=w(c,a.parentNode),b,e;b=-1;for(e=d.length;++b<e;)if(d[b]===a)return!0;return!1};return w}(),V=function(b){return"object"==typeof b&&5===W(b)},S=function(b,a,c){b.attachEvent?b.attachEvent("on"+a,c):b.addEventListener(a,c,!1)},Y=function(){var b=["0","0","0"];return function(){for(var a=
b.length,c;a;){a--;c=b[a].charCodeAt(0);if(57==c)return b[a]="A",b.join("");if(90==c)b[a]="0";else return b[a]=String.fromCharCode(c+1),b.join("")}b.unshift("0");return b.join("")}}(),ea=function(){this.events={}};ea.prototype={createEvent:function(b,a){b=b.toLowerCase();var c=this.events;c[b]||(c[b]=new fa(b,a));return c[b]},getEvent:function(b){b=b.toLowerCase();return this.events[b]},on:function(b,a,c,d){b=b.toLowerCase();var e=this.events;e[b]||(e[b]=new fa(b));return e[b].on(a,c,d)},once:function(b,
a,c,d){d=d||{};d.limit=1;return this.on(b,a,c,d)},un:function(b,a,c){b=b.toLowerCase();var d=this.events;d[b]&&d[b].un(a,c)},hasListener:function(b,a,c){b=b.toLowerCase();var d=this.events;return d[b]?d[b].hasListener(a,c):!1},removeAllListeners:function(b){var a=this.events;a[b]&&a[b].removeAllListeners()},trigger:function(){var b=arguments[0],a=this.events,b=b.toLowerCase();if(!a[b])return null;b=a[b];return b.trigger.apply(b,U.call(arguments,1))},suspendEvent:function(b){b=b.toLowerCase();var a=
this.events;a[b]&&a[b].suspend()},suspendAllEvents:function(){var b=this.events,a;for(a in b)b[a].suspend()},resumeEvent:function(b){b=b.toLowerCase();var a=this.events;a[b]&&a[b].resume()},resumeAllEvents:function(){var b=this.events,a;for(a in b)b[a].resume()},destroyEvent:function(b){var a=this.events;a[b]&&(a[b].removeAllListeners(),a[b].destroy(),delete a[b])},destroy:function(b){var a=this.events;if(b)b=b.toLowerCase(),a[b]&&(a[b].destroy(),delete a[b]);else{for(var c in a)a[c].destroy();this.events=
{}}},getApi:function(){if(!this.api){for(var b="createEvent getEvent on un once hasListener removeAllListeners trigger suspendEvent suspendAllEvents resumeEvent resumeAllEvents destroyEvent".split(" "),a={},c,d=-1,e=b.length;++d<e;c=b[d],a[c]=l(this[c],this));this.api=a}return this.api}};var fa=function(b,a){this.name=b;this.listeners=[];this.map={};this.hash=Y();this.uni="$$"+b+"_"+this.hash;this.suspended=!1;this.lid=0;this.returnResult=void 0===a?null:a};fa.prototype={getName:function(){return this.name},
destroy:function(){this.map=this.listeners=null},on:function(b,a,c){if(!b)return null;a=a||null;c=c||{};var d=this.uni,e=a||b;if(e[d]&&!c.allowDupes)return null;var f=++this.lid,g=c.first||!1;e[d]=f;b={fn:b,scope:a,uniScope:e,id:f,called:0,limit:c.limit||0,start:c.start||1,count:0,append:c.append,prepend:c.prepend};g?this.listeners.unshift(b):this.listeners.push(b);this.map[f]=b;return f},once:function(b,a,c){c=c||{};c.once=!0;return this.on(b,a,c)},un:function(b,a){var c=-1,d=this.uni,e=this.listeners,
f;f=b==parseInt(b)?b:(a||b)[d];if(!f)return!1;for(var g=0,k=e.length;g<k;g++)if(e[g].id==f){c=g;delete e[g].uniScope[d];break}if(-1==c)return!1;e.splice(c,1);delete this.map[f];return!0},hasListener:function(b,a){var c=this.listeners,d;if(b){a=a||b;d=t(b)?a[this.uni]:b;if(!d)return!1;for(var e=0,f=c.length;e<f;e++)if(c[e].id==d)return!0;return!1}return 0<c.length},removeAllListeners:function(){var b=this.listeners,a=this.uni,c,d;c=0;for(d=b.length;c<d;c++)delete b[c].uniScope[a];this.listeners=[];
this.map={}},suspend:function(){this.suspended=!0},resume:function(){this.suspended=!1},_prepareArgs:function(b,a){var c;b.append||b.prepend?(c=U.call(a),b.prepend&&(c=b.prepend.concat(c)),b.append&&(c=c.concat(b.append))):c=a;return c},trigger:function(){var b=this.listeners,a=this.returnResult;if(this.suspended||0==b.length)return null;for(var c="all"==a?[]:null,d,e,b="first"==a?[b[0]]:U.call(b);d=b.shift();)if(d&&this.map[d.id]&&(d.count++,!(d.count<d.start))){e=d.fn.apply(d.scope,this._prepareArgs(d,
arguments));d.called++;d.called==d.limit&&this.un(d.id);"all"==a&&c.push(e);if("first"==a)return e;"last"==a&&(c=e);if(!1==a&&!1===e)break}if(a)return c}};var I=function(b){if(!b||!b.then)return!1;var a,c;return"object"!=(c=typeof b)&&"function"!=c?!1:t(a=b.then)?a:!1},Z=function(){var b=[],a=!1,c="undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)},d=function(){a=!0;var e=b.shift();c(function(){e[0].apply(e[1],e[2]);b.length?d():a=!1},0)},e=function(c,e,f){f=f||[];b.push([c,
e,f]);a||d()},f=function(a,c){return function(d){try{c.resolve(a(d))}catch(b){c.reject(b)}}},g=function(a,c){if(a instanceof g)return a;if(!(this instanceof g))return new g(a,c);var d;this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if(0<arguments.length)if(d=I(a))a instanceof g?a.then(l(this.resolve,this),l(this.reject,this)):(new g(d,a)).then(l(this.resolve,this),l(this.reject,this));else if(t(a))try{a.call(c,l(this.resolve,this),l(this.reject,this))}catch(b){this.reject(b)}else this.resolve(a)};
g.prototype={_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},isRejected:function(){return 2==this._state},_cleanup:function(){delete this._fulfills;delete this._rejects;delete this._dones;delete this._fails},_processValue:function(a,c){var d;if(0==this._state)if(a===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{try{if(d=
I(a)){a instanceof g?a.then(l(this._processResolveValue,this),l(this._processRejectReason,this)):(new g(d,a)).then(l(this._processResolveValue,this),l(this._processRejectReason,this));return}}catch(b){0==this._state&&this._doReject(b);return}c.call(this,a)}},_callResolveHandlers:function(){this._done();for(var a=this._fulfills,c;c=a.shift();)e(c[0],c[1],[this._value]);this._cleanup()},_doResolve:function(a){this._value=a;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(a){this._processValue(a,
this._doResolve)},resolve:function(a){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(a);return this},_callRejectHandlers:function(){this._fail();for(var a=this._rejects,c;c=a.shift();)e(c[0],c[1],[this._reason]);this._cleanup()},_doReject:function(a){this._state=2;this._reason=a;0==this._wait&&this._callRejectHandlers()},_processRejectReason:function(a){this._processValue(a,this._doReject)},reject:function(a){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(a);
return this},then:function(a,c){var d=new g,b=this._state;0==b||0!=this._wait?(a&&t(a)?this._fulfills.push([f(a,d),null]):this._fulfills.push([d.resolve,d]),c&&t(c)?this._rejects.push([f(c,d),null]):this._rejects.push([d.reject,d])):1==b?a&&t(a)?e(f(a,d),null,[this._value]):d.resolve(this._value):2==b&&(c&&t(c)?e(f(c,d),null,[this._reason]):d.reject(this._reason));return d},"catch":function(a){return this.then(null,a)},_done:function(){for(var a=this._dones,c;c=a.shift();)try{c[0].call(c[1]||null,
this._value)}catch(d){K(d)}},done:function(a,c){var d=this._state;if(1==d&&0==this._wait)try{a.call(c||null,this._value)}catch(b){K(b)}else 0==d&&this._dones.push([a,c]);return this},_fail:function(){for(var a=this._fails,c;c=a.shift();)try{c[0].call(c[1]||null,this._reason)}catch(d){K(d)}},fail:function(a,c){var d=this._state;if(2==d&&0==this._wait)try{a.call(c||null,this._reason)}catch(b){K(b)}else 0==d&&this._fails.push([a,c]);return this},always:function(a,c){this.done(a,c);this.fail(a,c);return this},
promise:function(){return{then:l(this.then,this),done:l(this.done,this),fail:l(this.fail,this),always:l(this.always,this)}},after:function(a){var c=this;if(I(a)){c._wait++;var d=function(){c._wait--;0==c._wait&&0!=c._state&&(1==c._state?c._callResolveHandlers():c._callRejectHandlers())};t(a.done)?a.done(d):a.then(d)}return c}};g.fcall=function(a,c,d){return g.resolve(a.apply(c,d||[]))};g.resolve=function(a){var c=new g;c.resolve(a);return c};g.reject=function(a){var c=new g;c.reject(a);return c};
g.all=function(a){if(!a.length)return g.resolve(null);var c=new g,d=a.length,b=Array(d),e=d,f,h,l=function(a,d){b[d]=a;e--;0==e&&c.resolve(b)};for(f=0;f<d;f++)(function(d){h=a[f];h instanceof g?h.done(function(a){l(a,d)}).fail(c.reject,c):I(h)||t(h)?(new g(h)).done(function(a){l(a,d)}).fail(c.reject,c):l(h,d)})(f);return c};g.when=function(){return g.all(arguments)};g.allResolved=function(a){if(!a.length)return g.resolve(null);var c=new g,d=a.length,b=[],e=d,f,h,l=function(a){b.push(a);p()},p=function(){e--;
0==e&&c.resolve(b)};for(f=0;f<d;f++)h=a[f],h instanceof g?h.done(l).fail(p):I(h)||t(h)?(new g(h)).done(l).fail(p):l(h);return c};g.race=function(a){if(!a.length)return g.resolve(null);var c=new g,d=a.length,b,e;for(b=0;b<d&&(e=a[b],e instanceof g?e.done(c.resolve,c).fail(c.reject,c):I(e)||t(e)?(new g(e)).done(c.resolve,c).fail(c.reject,c):c.resolve(e),c.isPending());b++);return c};g.waterfall=function(a){if(!a.length)return g.resolve(null);for(var c=a.shift(),c=t(c)?g.fcall(c):g.resolve(d),d;d=a.shift();)I(d)?
c=c.then(function(a){return function(){return a}}(d)):t(d)?c=c.then(d):c.resolve(d);return c};g.counter=function(a){var c=new g;c.countdown=function(){a--;0==a&&c.resolve()};return c};return g}(),la=function(b){b=W(b);return 3>b&&-1<b},pa=function(){var b=/#.*$/,a=/([?&])_=[^&]*/,c=/\?/,d=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,e=/^(?:GET|HEAD)$/i,f=function(a,c,d){var b,e;if(la(a)&&d)c.push(encodeURIComponent(d)+"="+encodeURIComponent(""+a));else if(V(a)&&d)for(b=0,e=a.length;b<
e;b++)f(a[b],c,d+"["+b+"]");else if(N(a))for(b in a)a.hasOwnProperty(b)&&f(a[b],c,d?d+"["+b+"]":b)},g=function(d,g){d.replace(b,"");if(!1===g.cache){var C=(new Date).getTime();return a.test(d)?d.replace(a,"$1_="+C):d+(c.test(d)?"&":"?")+"_="+C}!g.data||window.FormData&&g.data instanceof window.FormData||(u(g.data)?C=g.data:(C=[],f(g.data,C,null),C=C.join("&").replace(/%20/g,"+")),g.data=C,e.test(g.method)&&(d+=(c.test(d)?"&":"?")+g.data,g.data=null));return d},k={xml:"application/xml, text/xml",html:"text/html",
script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"},z={url:null,data:null,method:"GET",headers:null,username:null,password:null,cache:null,dataType:null,timeout:0,contentType:"application/x-www-form-urlencoded",xhrFields:null,jsonp:!1,jsonpParam:null,jsonpCallback:null,transport:null,replace:!1,selector:null,form:null,beforeSend:null,progress:null,uploadProgress:null,processResponse:null,callbackScope:null},m={},B=new ea,v=function(a){var c;
c=eval;a&&(/^[^\S]*use strict/.test(a)?(c=document.createElement("script"),c.text=a,document.head.appendChild(c).parentNode.removeChild(c)):c(a))},A=function(a,c,d){var b,e;if(!N(a)&&!t(a)&&d)b=document.createElement("input"),b.setAttribute("type","hidden"),b.setAttribute("name",d),b.setAttribute("value",a),c.appendChild(b);else if(V(a)&&d)for(b=0,e=a.length;b<e;b++)A(a[b],c,d+"["+b+"]");else if(N(a))for(b in a)a.hasOwnProperty(b)&&A(a[b],c,d?d+"["+b+"]":b)},F=function(a){for(var c,d,b="",e=0;e<a.elements.length;e++)if(c=
a.elements[e],null!==c.getAttribute("name"))if(d="INPUT"===c.nodeName.toUpperCase()?c.getAttribute("type").toUpperCase():"TEXT","FILE"===d)for(d=0;d<c.files.length;b+="&"+encodeURIComponent(c.name)+"="+encodeURIComponent(c.files[d++].name));else if("RADIO"!==d&&"CHECKBOX"!==d||c.checked)b+="&"+encodeURIComponent(c.name)+"="+encodeURIComponent(c.value);return b},J=function(a,c,d){var b=c?c.dataType:null;c=c?c.selector:null;if(!u(a))return a;d=d||"";if("xml"===b||!b&&0<=d.indexOf("xml"))return a=ia(ha(a)),
c?ka(c,a):a;if("html"===b)return a=ia(a,"text/html"),c?ka(c,a):a;if("fragment"==b){d=document.createDocumentFragment();b=document.createElement("div");for(b.innerHTML=a;b.firstChild;)d.appendChild(b.firstChild);return d}if("json"===b||!b&&0<=d.indexOf("json"))return oa(ha(a));("script"===b||!b&&0<=d.indexOf("javascript"))&&v(a);return a+""},ja=function(a){var c=d.exec((window?window.location.href:"").toLowerCase())||[],b=d.exec(a.url.toLowerCase());this._opt=a;!0!==a.crossDomain&&(a.crossDomain=!(!b||
b[1]===c[1]&&b[2]===c[2]&&(b[3]||("http:"===b[1]?"80":"443"))===(c[3]||("http:"===c[1]?"80":"443"))));c=new Z;"iframe"!=a.transport||a.form?a.form&&(this._form=a.form,"POST"!=a.method||window&&window.FormData||(a.transport="iframe")):(this.createForm(),a.form=this._form);a.form&&"iframe"!=a.transport&&(a.data="POST"==a.method?new FormData(a.form):F(a.form));a.url=g(a.url,a);b=!a.crossDomain&&"script"!=a.transport||a.form?"iframe"==a.transport?new D(a,c,this):new G(a,c,this):new I(a,c,this);this._deferred=
c;this._transport=b;c.done(function(a){B.trigger("success",a)});c.fail(function(a){B.trigger("error",a)});c.always(function(){B.trigger("end")});B.trigger("start");a.timeout&&(this._timeout=setTimeout(l(this.onTimeout,this),a.timeout));a.jsonp&&this.createJsonp();!1===B.trigger("beforeSend",a,b)&&(this._promise=Z.reject());a.beforeSend&&!1===a.beforeSend.call(a.callbackScope,a,b)&&(this._promise=Z.reject());this._promise||(ga(b.send,b),c.abort=l(this.abort,this),c.always(this.destroy,this),this._promise=
c)};ja.prototype={_jsonpName:null,_transport:null,_opt:null,_deferred:null,_promise:null,_timeout:null,_form:null,_removeForm:!1,promise:function(){return this._promise},abort:function(a){this._transport.abort();this._deferred.reject(a||"abort")},onTimeout:function(){this.abort("timeout")},createForm:function(){var a=document.createElement("form");a.style.display="none";a.setAttribute("method",this._opt.method);A(this._opt.data,a,null);document.body.appendChild(a);this._form=a;this._removeForm=!0},
createJsonp:function(){var a=this._opt,d=a.jsonpParam||"callback",b=a.jsonpCallback||"jsonp_"+Y();a.url+=(c.test(a.url)?"&":"?")+d+"="+b;this._jsonpName=b;"undefined"!=typeof window&&(window[b]=l(this.jsonpCallback,this));"undefined"!=typeof global&&(global[b]=l(this.jsonpCallback,this));return b},jsonpCallback:function(a){var c;try{c=this.processResponseData(a)}catch(d){this._deferred?this._deferred.reject(d):K(d)}this._deferred&&this._deferred.resolve(c)},processResponseData:function(a,c){var d=
this._opt;a=J(a,d,c);B.hasListener("processResponse")&&(a=B.trigger("processResponse",a,this._deferred));d.processResponse&&(a=d.processResponse.call(d.callbackScope,a,this._deferred));return a},processResponse:function(a,c){var d=this._deferred,b;if(this._opt.jsonp)if(a){try{v(a)}catch(e){d.reject(e)}d.isPending()&&d.reject("jsonp script didn't invoke callback")}else d.reject("jsonp script is empty");else{try{b=this.processResponseData(a,c)}catch(f){d.reject(f)}d.resolve(b)}},destroy:function(){this._timeout&&
clearTimeout(this._timeout);this._form&&this._form.parentNode&&this._removeForm&&this._form.parentNode.removeChild(this._form);this._transport.destroy();delete this._transport;delete this._opt;delete this._deferred;delete this._promise;delete this._timeout;delete this._form;this._jsonpName&&("undefined"!=typeof window&&delete window[this._jsonpName],"undefined"!=typeof global&&delete global[this._jsonpName])}};var y=function(a,c){c=c||{};a&&!u(a)?c=a:c.url=a;if(!c.url&&(c.form&&(c.url=c.form.getAttribute("action")),
!c.url))throw"Must provide url";p(c,m,!1,!0);p(c,z,!1,!0);c.method=c.method?c.method.toUpperCase():c.form?c.form.getAttribute("method").toUpperCase()||"GET":"GET";return(new ja(c)).promise()};y.setup=function(a){p(m,a,!0,!0)};y.on=function(){B.on.apply(B,arguments)};y.un=function(){B.un.apply(B,arguments)};y.get=function(a,c){c=c||{};c.method="GET";return y(a,c)};y.post=function(a,c){c=c||{};c.method="POST";return y(a,c)};y.load=function(a,c,d){d=d||{};u(c)||(d=c);d.dataType="fragment";return y(c,
d).done(function(c){if(d.replace)for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(c)})};y.loadScript=function(a){return y(a,{transport:"script"})};y.submit=function(a,c){c=c||{};c.form=a;return y(null,c)};var G=function(a,c,d){var b;if(!(window.XMLHttpRequest&&(b=new XMLHttpRequest)||(b=new ActiveXObject("Msxml2.XMLHTTP"))||(b=new ActiveXObject("Microsoft.XMLHTTP"))))throw"Unable to create XHR object";this._xhr=b;this._deferred=c;this._opt=a;this._ajax=d;a.progress&&S(b,"progress",l(a.progress,
a.callbackScope));a.uploadProgress&&b.upload&&S(b.upload,"progress",l(a.uploadProgress,a.callbackScope));b.onreadystatechange=l(this.onReadyStateChange,this)};G.prototype={_xhr:null,_deferred:null,_ajax:null,setHeaders:function(){var a=this._opt,c=this._xhr,d;if(a.xhrFields)for(d in a.xhrFields)c[d]=a.xhrFields[d];a.data&&a.contentType&&c.setRequestHeader("Content-Type",a.contentType);c.setRequestHeader("X-Requested-With","XMLHttpRequest");c.setRequestHeader("Accept",a.dataType&&k[a.dataType]?k[a.dataType]+
", */*; q=0.01":k._default);for(d in a.headers)c.setRequestHeader(d,a.headers[d])},onReadyStateChange:function(){var a=this._xhr,c=this._deferred;if(0===a.readyState)a.onreadystatechange=h,c.resolve(a);else if(4===a.readyState){a.onreadystatechange=h;var d;a:{try{d=!a.status&&location&&"file:"==location.protocol||200<=a.status&&300>a.status||304===a.status||1223===a.status;break a}catch(b){}d=!1}d?this._ajax.processResponse(u(a.responseText)?a.responseText:void 0,a.getResponseHeader("content-type")||
""):c.reject(a)}},abort:function(){this._xhr.onreadystatechange=h;this._xhr.abort()},send:function(){var a=this._opt;try{this._xhr.open(a.method,a.url,!0,a.username,a.password),this.setHeaders(),this._xhr.send(a.data)}catch(c){this._deferred.reject(c)}},destroy:function(){delete this._xhr;delete this._deferred;delete this._opt;delete this._ajax}};var I=function(a,c,d){this._opt=a;this._ajax=d;this._deferred=c};I.prototype={_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("script");
a.setAttribute("async","async");a.setAttribute("charset","utf-8");a.setAttribute("src",this._opt.url);S(a,"load",l(this.onLoad,this));S(a,"error",l(this.onError,this));document.head.appendChild(a);this._el=a},onLoad:function(a){this._deferred&&this._deferred.resolve(a)},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;
delete this._ajax;delete this._deferred}};var D=function(a,c,d){this._opt=a;this._ajax=d;this._deferred=c};D.prototype={_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("iframe"),c="frame-"+Y(),d=this._opt.form;a.setAttribute("id",c);a.setAttribute("name",c);a.style.display="none";document.body.appendChild(a);d.setAttribute("action",this._opt.url);d.setAttribute("target",c);S(a,"load",l(this.onLoad,this));S(a,"error",l(this.onError,this));this._el=a;try{d.submit()}catch(b){this._deferred.reject(b)}},
onLoad:function(){var a=this._el;this._opt&&!this._opt.jsonp&&(a=a.contentDocument||a.contentWindow.document,a=a.body.innerHTML,this._ajax.processResponse(a))},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;delete this._ajax;delete this._deferred}};return y}(),A=J.factory,$=function(){var b={},a={};return G("MetaphorJs.data.Model",
{type:null,fields:null,record:null,store:null,plain:!1,lastAjaxResponse:null,initialize:function(a){this.fields={};p(this,{record:{load:null,save:null,"delete":null,id:null,data:null,success:null,extra:{}},store:{load:null,save:null,"delete":null,id:null,data:null,total:null,start:null,limit:null,success:null,extra:{}}},!1,!0);p(this,a,!0,!0);this.plain=!this.type},isPlain:function(){return this.plain},getRecordProp:function(a,d){return this.getProp("record",a,d)},setRecordProp:function(a,d){this.record[a]=
d},getStoreProp:function(a,d){return this.getProp("store",a,d)},setStoreProp:function(a,d){this.store[a]=d},getProp:function(a,d,b){a=this[a];return a[d]&&a[d][b]||a[b]||this[b]||null},setProp:function(a,d){return this[a]=d},_makeRequest:function(a,d,b,f,g){var k=this,h=k[a],m=p({},u(h[d])||t(h[d])?{url:h[d]}:h[d]),l=k.getProp(a,d,"id"),v=k.getProp(a,d,"data"),A=k.getProp(a,d,"url"),F=k.getProp(a,d,"json");if(!m)if(A)m={url:A};else throw a+"."+d+" not defined";if(u(m)||t(m))m={url:m};if(!m.url){if(!A)throw a+
"."+d+" url not defined";m.url=A}m.data=p({},m.data,k.extra,h.extra,h[d]?h[d].extra:{},g,!0,!0);if(t(m.url)){b=m.url(m.data);var G=new Z;b.then(function(b){"record"==a?k._processRecordResponse(d,b,G):"store"==a&&k._processStoreResponse(d,b,G)});return G}m.method||(m.method="load"==d?"GET":"POST");b&&(m.data[l]=b);f&&(v?m.data[v]=f:m.data=f);F&&m.data&&"GET"!=m.method&&(m.data=JSON.stringify(m.data));m.callbackScope=k;"record"==a?m.processResponse=function(a,c){k.lastAjaxResponse=a;k._processRecordResponse(d,
a,c)}:"store"==a&&(m.processResponse=function(a,c){k.lastAjaxResponse=a;k._processStoreResponse(d,a,c)});return pa(m)},_processRecordResponse:function(a,d,b){var f=this.getRecordProp(a,"id"),g=this.getRecordProp(a,"data"),f=(g=g?d[g]:d)&&g[f]||d[f];this._getSuccess("record",a,d)?b.resolve({id:f,data:g}):b.reject(d)},_processStoreResponse:function(a,d,b){var f=this.getStoreProp(a,"data"),g=this.getStoreProp(a,"total"),f=f?d[f]:d,g=g?d[g]:null;this._getSuccess("store",a,d)?b.resolve({data:f,total:g}):
b.reject(d)},_getSuccess:function(a,d,b){return(a=this.getProp(a,d,"success"))&&void 0!=b[a]?b[a]:!0},loadRecord:function(a){return this._makeRequest("record","load",a)},saveRecord:function(a,d,b){return this._makeRequest("record",a.getId()?"save":"create",a.getId(),p({},a.storeData(a.getData(d)),b))},deleteRecord:function(a){return this._makeRequest("record","delete",a.getId())},loadStore:function(a,d){return this._makeRequest("store","load",null,null,d)},saveStore:function(a,d){return this._makeRequest("store",
"save",null,d)},deleteRecords:function(a,d){return this._makeRequest("store","delete",d)},getFields:function(){return this.fields},restoreField:function(a,d,b){var f=this.fields[d];if(f){switch(u(f)?f:f.type){case "int":b=parseInt(b);break;case "bool":case "boolean":u(b)?(b=b.toLowerCase(),b=!("off"===b||"no"===b||"0"===b||"false"==b||"null"==b)):b=b?!0:!1;break;case "double":case "float":b=parseFloat(b);break;case "date":f.parseFn?b=f.parseFn(b,f.format):Date.parse?b=Date.parse(b,f.format):("timestamp"==
f.format&&(b=1E3*parseInt(b)),b=new Date(b))}f.restore&&(b=f.restore.call(a,b,d))}return this.onRestoreField(a,d,b)},onRestoreField:function(a,b,e){return e},storeField:function(a,b,e){var f=this.fields[b];if(f){switch(u(f)?f:f.type){case "bool":case "boolean":e=e?"1":"0";break;case "date":e=f.formatFn?f.formatFn(e,f.format):Date.format?Date.format(e,f.format):"timestamp"==f.format?e.getTime()/1E3:e.format?e.format(f.format):e.toString();break;default:e=e.toString()}f.store&&(e=f.store.call(a,e,b))}return this.onStoreField(a,
b,e)},onStoreField:function(a,b,e){return e}},{create:function(a,d){return"MetaphorJs.data.Model"==a?A(a,d):d?A(a,d):b[a]?b[a]:b[a]=A(a)},addToCache:function(c){var b=c.getClass(),e=c.getId();"MetaphorJs.data.Record"!=b&&(a[b]||(a[b]={}),a[b][e]=c)},getFromCache:function(c,b){return a[c]&&a[c][b]?a[c][b]:null},removeFromCache:function(c,b){a[c]&&a[c][b]&&delete a[c][b]}})}(),qa=J.isInstanceOf;G("MetaphorJs.cmp.Base",{destroyed:!1,_observable:null,initialize:function(b){b=b||{};this._observable=new ea;
p(this,this._observable.getApi(),!0,!1);if(b.callback){var a=b.callback,c=a.scope||this;delete a.scope;for(var d in a)if(a.hasOwnProperty(d))this.on(d,a[d],c);delete b.callback}p(this,b,!0,!1)},destroy:function(){if(!this.destroyed){if(!1===this.trigger("beforedestroy",this))return!1;this.onDestroy();this.destroyed=!0;this.trigger("destroy",this);this._observable.destroy();delete this._observable}},onDestroy:h});var T=G("MetaphorJs.data.Record","MetaphorJs.cmp.Base",{id:null,data:null,orig:null,modified:null,
loaded:!1,dirty:!1,destroyed:!1,model:null,standalone:!0,stores:null,initialize:function(b,a,c){var d=arguments.length;1==d?(c=b,a=b=null):2==d&&(c=a,a=null);this.data={};this.orig={};this.stores=[];this.modified={};c=c||{};this.supr(c);u(this.model)?this.model=A(this.model):qa(this.model,"MetaphorJs.data.Model")||(this.model=A("MetaphorJs.data.Model",this.model));this.id=b;a?this.importData(a):!1!==c.autoLoad&&b&&this.load();"MetaphorJs.data.Record"!=this.getClass()&&$.addToCache(this)},isLoaded:function(){return this.loaded},
isStandalone:function(){return this.standalone},isDirty:function(){return this.dirty},getModel:function(){return this.model},attachStore:function(b){b=b.getId();-1==this.stores.indexOf(b)&&this.stores.push(b)},detachStore:function(b){b=b.getId();var a;this.destroyed||-1==(a=this.stores.indexOf(b))||(this.stores.splice(a,1),0!=this.stores.length||this.standalone||this.destroy())},setDirty:function(b){this.dirty!=b&&(this.dirty=!!b,this.trigger("dirtychange",this,b))},importData:function(b){var a={},
c;if(b){for(c in b)a[c]=this.model.restoreField(this,c,b[c]);this.data=a}this.orig=p({},this.data);this.modified={};this.loaded=!0;this.setDirty(!1)},storeData:function(b){var a={},c;for(c in b)a[c]=this.model.storeField(this,c,b[c]);return a},getId:function(){return this.id},getData:function(b){if(b){var a={},c,d;b=u(b)?[b]:b;c=0;for(d=b.length;c<d;c++)a[b[c]]=this.data[b[c]];return a}return p({},this.data)},getChanged:function(){return p({},this.modified)},isChanged:function(b){return this.modified[b]||
!1},get:function(b){return this.data[b]},setId:function(b){!this.id&&b&&(this.id=b)},set:function(b,a){var c=this.data[b];a=this.model.restoreField(this,b,a);this.data[b]=a;c!=a&&(this.modified[b]=!0,this.setDirty(!0),this.trigger("change",this,b,a,c),this.trigger("change-"+b,this,b,a,c))},revert:function(){this.dirty&&(this.data=p({},this.orig),this.modified={},this.setDirty(!1))},load:function(){var b=this;b.trigger("beforeload",b);return b.model.loadRecord(b.id).done(function(a){b.setId(a.id);
b.importData(a.data);b.trigger("load",b)}).fail(function(){b.trigger("failedload",b)})},save:function(b,a){var c=this;c.trigger("beforesave",c);return c.model.saveRecord(c,b,a).done(function(a){c.setId(a.id);c.importData(a.data);c.trigger("save",c)}).fail(function(a){c.trigger("failedsave",c)})},"delete":function(){var b=this;b.trigger("beforedelete",b);return b.model.deleteRecord(b).done(function(){b.trigger("delete",b);b.destroy()}).fail(function(){b.trigger("faileddelete",b)})},reset:function(){this.id=
null;this.data={};this.orig={};this.modified={};this.dirty=this.loaded=!1;this.trigger("reset",this)},destroy:function(){this.destroyed||(this.destroyed=!0,this.trigger("destroy",this),this.stores=this.model=this.modified=this.orig=this.data=null,$.removeFromCache(this.getClass(),this.id),this.supr())}}),ra=function(){var b=function(a,c,b){if(t(c))return c(a,b);if(""===c||void 0===c)return!0;if(void 0!==a){if(ca(a))return a===c;if(c instanceof RegExp)return c.test(""+a);if("strict"==b)return""+a===
""+c;if(!0===b||null===b||void 0===b)return-1!=""+a.indexOf(c);if(!1===b)return-1==""+a.indexOf(c)}return!1},a=function(a,c,f){if(la(a))return void 0===c.$?!0:b(a,c.$,f);var g,k;for(g in c)if("$"==g)for(k in a){if(b(a[k],c.$,f))return!0}else if(b(a[g],c[g],f))return!0;return!1},c=function(c,b,f){X(b)||(b={$:b});var g=[],k,h;k=-1;for(h=c.length;++k<h;)a(c[k],b,f)&&g.push(c[k]);return g};c.compare=a;return c}(),sa=function(b,a,c){c||(c="asc");b=b.slice();b.sort(function(c,b){var f=typeof c,g=c,k=b;
if(f!=typeof b)return 0;"object"==f&&(t(a)?(g=a(c),k=a(b)):(g=c[a],k=b[a]));if("number"==typeof g)return g-k;g=(""+g).toLowerCase();k=(""+k).toLowerCase();return g===k?0:g>k?1:-1});return"desc"==c?b.reverse():b},J=Array.prototype.indexOf;J||(J=Array.prototype.indexOf=function(b,a){var c;if(null==this)throw new TypeError('"this" is null or not defined');var d=Object(this),e=d.length>>>0;if(0===e)return-1;c=+a||0;Infinity===Math.abs(c)&&(c=0);if(c>=e)return-1;for(c=Math.max(0<=c?c:e-Math.abs(c),0);c<
e;){if(c in d&&d[c]===b)return c;c++}return-1});(function(){var b={};return G("MetaphorJs.data.Store","MetaphorJs.cmp.Base",{id:null,autoLoad:!1,clearOnLoad:!0,model:null,extraParams:null,loaded:!1,loading:!1,local:!1,items:null,current:null,map:null,currentMap:null,length:0,currentLength:0,maxLength:0,totalLength:0,start:0,pageSize:null,pages:null,filtered:!1,sorted:!1,filterBy:null,filterOpt:null,sortBy:null,sortDir:null,publicStore:!1,idProp:null,initialize:function(a,c,d){this.items=[];this.current=
[];this.map={};this.currentMap={};this.loaded=!1;this.extraParams=this.extraParams||{};a&&!u(a)&&(d=c,c=a,a=null);c=c||{};a&&(c.url=a);this.supr(c);this.id=this.id||Y();this.publicStore&&(b[this.id]=this);this.initModel(c);this.createEvent("beforeload",!1);!this.local&&this.autoLoad?this.load():d&&(V(d)?this._loadArray(d):this._loadAjaxData(d));this.local&&(this.loaded=!0)},initModel:function(a){u(this.model)?this.model=A(this.model):this.model instanceof $||(this.model=A("MetaphorJs.data.Model",
this.model));a.url&&(this.model.store.load=a.url);this.idProp=this.model.getStoreProp("load","id")},getId:function(){return this.id},isLoaded:function(){return this.loaded},isLocal:function(){return this.local},setLocal:function(a){this.local=!!a},isLoading:function(){return this.loading},isFiltered:function(){return this.filtered},isSorted:function(){return this.sorted},getLength:function(a){return a?this.length:this.currentLength},getTotalLength:function(){return this.totalLength||this.currentLength},
getPagesCount:function(){return null!==this.pageSize?parseInt(this.totalLength/this.pageSize):1},setParam:function(a,c){this.extraParams[a]=c},getParam:function(a){return this.extraParams[a]},setStart:function(a){this.start=a},setPageSize:function(a){this.pageSize=a},getAjaxData:function(){return this.ajaxData},hasDirty:function(a){if(this.model.isPlain())return!1;var c=!1;this.each(function(a){return a.isDirty()?(c=!0,!1):!0},null,a);return c},getDirty:function(a){var c=[];if(this.model.isPlain())return c;
this.each(function(a){a.isDirty()&&c.push(a)},null,a);return c},getModel:function(){return this.model},_loadAjaxData:function(a,c){var b=this;c=c||{};if(c.silent||!1!==b.trigger("beforeload",b))b.ajaxData=a,b.model._processStoreResponse("load",a,{resolve:function(a){b._onModelLoadSuccess(a,c)},reject:function(a){b._onModelLoadFail(a,c)}})},_loadArray:function(a,c){c=c||{};(c.silent||!1!==this.trigger("beforeload",this))&&V(a)&&(this._load(a,c),this.totalLength=this.length)},_load:function(a,c){var b=
c.prepend;c=c||{};for(var e=0;e<a.length;e++)b?this.insert(e,a[e],!0,!0):this.add(a[e],!0,!0);this.loaded=!0;this.loading=!1;this.trigger("loadingend",this);this.onLoad();c.skipUpdate||this.update();c.silent||this.trigger("load",this)},load:function(a,c){var b=this,e=b.model.store,f=e.start,e=e.limit,g=b.pageSize;c=c||{};if(b.local)return null;a=p({},b.extraParams,a||{});null===g||a[f]||a[e]||(f&&(a[f]=b.start),e&&(a[e]=g));if(!c.silent&&!1===b.trigger("beforeload",b))return null;b.loading=!0;b.trigger("loadingstart",
b);return b.model.loadStore(b,a).done(function(a){b.ajaxData=b.model.lastAjaxResponse;b._onModelLoadSuccess(a,c)}).fail(function(a){b.ajaxData=b.model.lastAjaxResponse;b._onModelLoadFail(a,c)})},_onModelLoadSuccess:function(a,c){c=c||{};if(!c.noopOnEmpty||a.data.length)!c.prepend&&!c.append&&this.clearOnLoad&&0<this.length&&this.clear(!0),this.totalLength=parseInt(a.total),this._load(a.data,c)},_onModelLoadFail:function(a,c){this.onFailedLoad();c.silent||this.trigger("failedload",this,a)},onLoad:h,
onFailedLoad:h,save:function(a){var c=this,b={},e=0;if(c.local)return null;if(c.model.isPlain())throw Error("Cannot save plain store");c.each(function(a){a.isDirty()&&(b[a.getId()]=a.storeData(a.getData()),e++)});if(!e)throw Error("Nothing to save");return a||!1!==c.trigger("beforesave",c,b)?c.model.saveStore(c,b).done(function(b){c._onModelSaveSuccess(b,a)}).fail(function(b){c._onModelSaveFail(b,a)}):null},_onModelSaveSuccess:function(a,c){var b,e,f,g=a.data;if(g&&g.length)for(b=0,e=g.length;b<e;b++)f=
this.getRecordId(g[b]),(f=this.getById(f))&&f.importData(g[b]);this.onSave();c||this.trigger("save",this)},_onModelSaveFail:function(a,c){this.onFailedSave(a);c||this.trigger("failedsave",this)},onSave:h,onFailedSave:h,deleteById:function(a,c,b){var e=this,f,g,h;if(e.local)return null;if(!a||V(a)&&!a.length)throw Error("Record id required");V(a)||(a=[a]);f=0;for(g=a.length;f<g;f++)h=e.getById(a[f]),e.remove(h,c,b),h instanceof T&&h.destroy();return c||!1!==e.trigger("beforedelete",e,a)?e.model.deleteRecords(e,
a).done(function(){e.totalLength-=a.length;e.onDelete();c||e.trigger("delete",e,a)}).fail(function(){e.onFailedDelete();c||e.trigger("faileddelete",e,a)}):null},onDelete:h,onFailedDelete:h,deleteAt:function(a,c,b){var e=this.getAt(a);if(!e)throw Error("Record not found at "+a);return this["delete"](e,c,b)},"delete":function(a,c,b){return this.deleteById(this.getRecordId(a),c,b)},deleteRecords:function(a,c,b){var e=[],f,g;f=0;for(g=a.length;f<g;f++)e.push(this.getRecordId(a[f]));return this.deleteById(e,
c,b)},loadOr:function(a,c,b){this.local||this.isLoading()||(this.isLoaded()?a&&a.call(c||this):this.load(null,b))},addPrevPage:function(a){a=a||{};a.append=!1;a.prepend=!0;a.noopOnEmpty=!0;return this.loadPrevPage(a)},addNextPage:function(a){a=a||{};a.append=!0;a.prepend=!1;a.noopOnEmpty=!0;if(!this.local&&(!this.totalLength||this.length<this.totalLength))return this.load({start:this.length,limit:this.pageSize},a)},loadNextPage:function(a){if(!this.local&&(!this.totalLength||this.length<this.totalLength))return this.start+=
this.pageSize,this.load(null,a)},loadPrevPage:function(a){if(!this.local&&0<this.start)return this.start-=this.pageSize,0>this.start&&(this.start=0),this.load(null,a)},loadPage:function(a,c){if(!this.local)return this.start=parseInt(a,10),0>this.start&&(this.start=0),this.load(null,c)},getRecordId:function(a){return a instanceof T?a.getId():a[this.idProp]||null},getRecordData:function(a){return this.model.isPlain()?a:a.data},processRawDataItem:function(a){if(a instanceof T||this.model.isPlain())return a;
var c=this.model.type,b=this.getRecordId(a),e;b&&(e=$.getFromCache(c,b));e||(e=A(c,b,a,{model:this.model,standalone:!1}));return e},bindRecord:function(a,c){c[a]("change",this.onRecordChange,this);c[a]("destroy",this.onRecordDestroy,this);c[a]("dirtychange",this.onRecordDirtyChange,this);return c},onRecordDirtyChange:function(a){this.trigger("update",this,a)},onRecordChange:function(a,c,b,e){this.trigger("update",this,a)},onRecordDestroy:function(a){this.remove(a)},shift:function(a,c,b){return this.removeAt(0,
a,c,b)},unshift:function(a,c,b){return this.insert(0,a,c,b)},pop:function(a,c,b){return this.removeAt(this.length-1,a,c,b)},addMany:function(a,c,b){var e,f,g=this.length;e=0;for(f=a.length;e<f;e++)this.insert(g+e,a[e],!0,!0);b||this.update();0<f&&!c&&this.trigger("add",a)},add:function(a,c,b){return this.insert(this.length,a,c,b)},onAdd:h,removeAt:function(a,c,b,e){e||(a=this.items.indexOf(this.current[a]));if(a<this.length&&0<=a)return this.length--,e=this.items[a],this.items.splice(a,1),a=this.getRecordId(e),
void 0!=a&&(delete this.map[a],delete this.currentMap[a]),this.onRemove(e,a),b||this.update(),c||this.trigger("remove",e,a),e instanceof T?(this.bindRecord("un",e),e.detachStore(this),e.destroyed?void 0:e):e},onRemove:h,insertMany:function(a,c,b,e){var f,g;f=0;for(g=c.length;f<g;f++)this.insert(a+f,c[f],!0,!0);0<g&&!e&&this.update();0<g&&!b&&this.trigger("add",c)},insert:function(a,c,b,e){var f,g=!1;c=this.processRawDataItem(c);f=this.getRecordId(c);this.map[f]&&(this.suspendAllEvents(),this.removeId(f),
this.resumeAllEvents());a>=this.length?(this.items.push(c),g=!0):this.items.splice(a,0,c);this.length++;this.maxLength&&this.length>this.maxLength&&(g?this.pop(b,!0):this.shift(b,!0));void 0!=f&&(this.map[f]=c);c instanceof T&&(c.attachStore(this),this.bindRecord("on",c));this.onAdd(a,c);e||this.update();b||this.trigger("add",[c]);return c},replace:function(a,c,b,e){var f;f=this.items.indexOf(a);this.removeAt(f,!0,!0,!0);this.insert(f,c,!0,!0);e||this.update();b||this.trigger("replace",a,c);return c},
onReplace:h,remove:function(a,c,b){return this.removeAt(this.indexOf(a,!0),c,b,!0)},removeId:function(a,c,b){return this.removeAt(this.indexOfId(a,!0),c,b,!0)},contains:function(a,c){return-1!=this.indexOf(a,c)},containsId:function(a,c){return c?void 0!==this.map[a]:void 0!==this.currentMap[a]},clear:function(a){var c=this.getRange();this._reset();this.onClear();a||this.trigger("clear",c)},onClear:h,reset:function(){this._reset();this.start=0},_reset:function(a){var c,b;if(!a)for(a=0,c=this.items.length;a<
c;a++)b=this.items[a],b instanceof T&&(this.bindRecord("un",b),b.detachStore(this));this.totalLength=this.currentLength=this.length=0;this.items=[];this.current=[];this.map={};this.currentMap={};this.loaded=this.local},getAt:function(a,c){return c?this.items[a]||void 0:this.current[a]||void 0},getById:function(a,c){return c?this.map[a]||void 0:this.currentMap[a]||void 0},indexOf:function(a,c){return c?this.items.indexOf(a):this.current.indexOf(a)},indexOfId:function(a,c){return this.indexOf(this.getById(a,
c),c)},each:function(a,c,b){b=b?this.items.slice():this.current.slice();for(var e=0,f=b.length;e<f&&!1!==a.call(c,b[e],e,f);e++);},eachId:function(a,c,b){var e=this;e.each(function(b,d,h){return a.call(c,e.getRecordId(b),d,h)},null,b)},collect:function(a,c){var b=[],e=!this.model.isPlain();this.each(function(c){(c=e?c.get(a):c[a])&&b.push(c)},null,c);return b},first:function(a){return a?this.items[0]:this.current[0]},last:function(a){return a?this.items[this.length-1]:this.current[this.current-1]},
getRange:function(a,c,b){b=b?this.items:this.current;var e=[];if(1>b.length)return e;a=a||0;c=Math.min(void 0==c?this.length-1:c,this.length-1);if(a<=c)for(;a<=c;a++)e.push(b[a]);else for(;a>=c;a--)e.push(b[a]);return e},findBy:function(a,b,d,e){a=this.findIndexBy(a,b,d,e);return-1==a?void 0:this.getAt(a,e)},findIndexBy:function(a,b,d,e){e=e?this.items:this.current;d=d||0;for(var f=e.length;d<f;d++)if(a.call(b,e[d],this.getRecordId(e[d])))return d;return-1},find:function(a,b,d,e){var f=!this.model.isPlain(),
g;return this.findIndexBy(function(e){g=f?e.get(a):e[a];return d?g===b:g==b},this,0,e)},findExact:function(a,b,d){return this.find(a,b,!0,d)},findBySet:function(a,b){var d=null,e,f;this.each(function(b){e=!0;for(f in a)if(a[f]!=b[f]){e=!1;break}return e?(d=b,!1):!0},null,b);return d},update:function(){var a=this,b=a.filtered,d=a.sorted;a.currentLength=a.length;a.currentMap=a.map;a.current=a.items;if(b){var e=a.filterBy,f=a.filterOpt,g,h;a.current=g=[];a.currentMap=h={};a.each(function(b){ra.compare(b.data,
e,f)&&(g.push(b),h[a.getRecordId(b)]=b)},null,!0);a.currentLength=a.current.length}if(d){var l=a.sortBy,m=!a.model.isPlain();a.current=sa(a.current,function(a){return m?a.get(l):a[l]},a.sortDir)}a.trigger("update",a)},filter:function(a,b){this.filtered=!0;this.filterBy=a;this.filterOpt=b;this.update()},clearFilter:function(){this.filtered&&(this.filterOpt=this.filterBy=null,this.update())},sort:function(a,b){this.sorted=!0;this.sortBy=a;this.sortDir=b;this.update()},clearSorting:function(){this.sorted=
!1;this.sortDir=this.sortBy=null;this.update()},onDestroy:function(){delete b[this.id];this.clear();this.supr()}},{lookupStore:function(a){return b[a]||null},eachStore:function(a,c){for(var d in b)if(!1===a.call(c||window,b[d]))break}})})();G("MetaphorJs.data.FirebaseStore","MetaphorJs.data.Store",{firebase:null,initialize:function(b){this.firebase=u(b)?new Firebase(b):b;this.firebase.on("child_added",l(this.onChildAdded,this));this.firebase.on("child_removed",l(this.onChildRemoved,this));this.firebase.on("child_changed",
l(this.onChildChanged,this));this.firebase.on("child_moved",l(this.onChildMoved,this));this.supr()},initModel:h,ref:function(){return this.firebase.ref?this.firebase.ref():this.firebase},load:function(){if(!this.loaded)this.firebase.once("value",l(this.onSnapshotLoaded,this))},onSnapshotLoaded:function(b){var a=this;b.forEach(function(b){a.add(b,!0,!0)});a.update();a.loaded=!0;a.trigger("load",a)},onChildAdded:function(b,a){if(this.loaded){var c=this.indexOfId(a,!0);this.insert(c+1,b)}},onChildRemoved:function(b){this.loaded&&
this.removeId(b.name())},onChildChanged:function(b,a){if(this.loaded){var c=this.getById(b.name(),!0);this.replace(c,b)}},onChildMoved:function(b,a){},getRecordId:function(b){return b.name()},getRecordData:function(b){return b.val()},processRawDataItem:function(b){return b},bindRecord:h});"undefined"!=typeof global?global.MetaphorJs=ba:window.MetaphorJs=ba})();
