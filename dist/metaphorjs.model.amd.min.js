define("metaphorjs-model",["metaphorjs-ajax","metaphorjs-promise","metaphorjs-namespace","metaphorjs-class"],function(s,x,y,t){var C=Array.prototype.slice,z=function(g){return!(!g||g.constructor!==Object)},m=function(g){return"undefined"==typeof g},g=function c(){var e=!1,a=!1,b=C.call(arguments),d=b.shift(),k,f,r;"boolean"==typeof b[b.length-1]&&(e=b.pop());"boolean"==typeof b[b.length-1]&&(a=e,e=b.pop());for(;b.length;)if(k=b.shift())for(f in k)if(k.hasOwnProperty(f)&&!m(r=k[f]))if(a)if(d[f]&&z(d[f])&&
z(r))c(d[f],r,e,a);else{if(!0===e||m(d[f])||null===d[f])z(r)?(d[f]={},c(d[f],r,e,!0)):d[f]=r}else if(!0===e||m(d[f])||null===d[f])d[f]=r;return d};x={lib:{},cmp:{},view:{}};y=new y(x,"MetaphorJs");t=new t(y);var v=t.define,n=t.factory,q=function(c){return"string"==typeof c},w=function(){var c={},e={};return v("MetaphorJs.data.Model",{type:null,fields:null,record:null,store:null,plain:!1,initialize:function(a){this.fields={};g(this,{record:{load:null,save:null,"delete":null,id:null,data:null,success:null,
extra:{}},store:{load:null,save:null,"delete":null,id:null,data:null,total:null,start:null,limit:null,success:null,extra:{}}},!1,!0);g(this,a,!0,!0);this.plain=!this.type},isPlain:function(){return this.plain},getRecordProp:function(a,b){return this.getProp("record",a,b)},setRecordProp:function(a,b){this.record[a]=b},getStoreProp:function(a,b){return this.getProp("store",a,b)},setStoreProp:function(a,b){this.store[a]=b},getProp:function(a,b,d){a=this[a];return a[b]&&a[b][d]||a[d]||this[d]||null},
setProp:function(a,b){return this[a]=b},_createAjaxCfg:function(a,b,d,k){var c=this,e=c[a],h=g({},q(e[b])?{url:e[b]}:e[b]),l=c.getProp(a,b,"id"),m=c.getProp(a,b,"data"),n=c.getProp(a,b,"url"),p=c.getProp(a,b,"json");if(!h)if(n)h={url:n};else throw a+"."+b+" not defined";q(h)&&(h={url:h});if(!h.url){if(!n)throw a+"."+b+" url not defined";h.url=n}h.data=g({},h.data,c.extra,e.extra,e[b]?e[b].extra:{},!1,!0);h.method||(h.method="load"==b?"GET":"POST");d&&(h.data[l]=d);k&&(m?h.data[m]=k:h.data=k);p&&h.data&&
"GET"!=h.method&&(h.data=JSON.stringify(h.data));h.callbackScope=c;"record"==a?h.processResponse=function(a,d){c._processRecordResponse(b,a,d)}:"store"==a&&(h.processResponse=function(a,d){c._processStoreResponse(b,a,d)});return h},_processRecordResponse:function(a,b,d){var k=this.getRecordProp(a,"id"),c=this.getRecordProp(a,"data"),k=(c=c?b[c]:b)&&c[k]||b[k];this._getSuccess("record",a,b)?d.resolve({id:k,data:c}):d.reject(b)},_processStoreResponse:function(a,b,d){var k=this.getStoreProp(a,"data"),
c=this.getStoreProp(a,"total"),k=k?b[k]:b,c=c?b[c]:null;this._getSuccess("store",a,b)?d.resolve({data:k,total:c}):d.reject(b)},_getSuccess:function(a,b,d){return(a=this.getProp(a,b,"success"))&&void 0!=d[a]?d[a]:!0},loadRecord:function(a){return s(this._createAjaxCfg("record","load",a))},saveRecord:function(a,b,d){return s(this._createAjaxCfg("record",a.getId()?"save":"create",a.getId(),g({},a.storeData(a.getData(b)),d)))},deleteRecord:function(a){return s(this._createAjaxCfg("record","delete",a.getId()))},
loadStore:function(a,b){return s(g(this._createAjaxCfg("store","load"),b,!0,!0))},saveStore:function(a,b){return s(this._createAjaxCfg("store","save",null,b))},deleteRecords:function(a,b){return s(this._createAjaxCfg("store","delete",b))},getFields:function(){return this.fields},restoreField:function(a,b,d){var c=this.fields[b];if(c){switch(q(c)?c:c.type){case "int":d=parseInt(d);break;case "bool":case "boolean":q(d)?(d=d.toLowerCase(),d=!("off"===d||"no"===d||"0"===d||"false"==d||"null"==d)):d=d?
!0:!1;break;case "double":case "float":d=parseFloat(d);break;case "date":c.parseFn?d=c.parseFn(d,c.format):Date.parse?d=Date.parse(d,c.format):("timestamp"==c.format&&(d=1E3*parseInt(d)),d=new Date(d))}c.restore&&(d=c.restore.call(a,d,b))}return this.onRestoreField(a,b,d)},onRestoreField:function(a,b,d){return d},storeField:function(a,b,d){var c=this.fields[b];if(c){switch(q(c)?c:c.type){case "bool":case "boolean":d=d?"1":"0";break;case "date":d=c.formatFn?c.formatFn(d,c.format):Date.format?Date.format(d,
c.format):"timestamp"==c.format?d.getTime()/1E3:d.format?d.format(c.format):d.toString();break;default:d=d.toString()}c.store&&(d=c.store.call(a,d,b))}return this.onStoreField(a,b,d)},onStoreField:function(a,b,d){return d}},{create:function(a,b){return"MetaphorJs.data.Model"==a?n(a,b):b?n(a,b):c[a]?c[a]:c[a]=n(a)},addToCache:function(a){var b=a.getClass(),d=a.getId();"MetaphorJs.data.Record"!=b&&(e[b]||(e[b]={}),e[b][d]=a)},getFromCache:function(a,b){return e[a]&&e[a][b]?e[a][b]:null},removeFromCache:function(a,
b){e[a]&&e[a][b]&&delete e[a][b]}})}(),A=t.isInstanceOf,l=function(){};v("MetaphorJs.cmp.Base",{destroyed:!1,_observable:null,initialize:function(c){c=c||{};this._observable=new Observable;g(this,this._observable.getApi(),!0,!1);if(c.callback){var e=c.callback,a=e.scope||this;delete e.scope;for(var b in e)if(e.hasOwnProperty(b))this.on(b,e[b],a);delete c.callback}g(this,c,!0,!1)},destroy:function(){if(!this.destroyed){if(!1===this.trigger("beforedestroy",this))return!1;this.onDestroy();this.destroyed=
!0;this.trigger("destroy",this);this._observable.destroy();delete this._observable}},onDestroy:l});var p=v("MetaphorJs.data.Record","MetaphorJs.cmp.Base",{id:null,data:null,orig:null,modified:null,loaded:!1,dirty:!1,destroyed:!1,model:null,standalone:!0,stores:null,initialize:function(c,e,a){var b=arguments.length;1==b?(a=c,e=c=null):2==b&&(a=e,e=null);this.data={};this.orig={};this.stores=[];this.modified={};a=a||{};this.supr(a);q(this.model)?this.model=n(this.model):A(this.model,"MetaphorJs.data.Model")||
(this.model=n("MetaphorJs.data.Model",this.model));this.id=c;e?this.importData(e):!1!==a.autoLoad&&c&&this.load();"MetaphorJs.data.Record"!=this.getClass()&&w.addToCache(this)},isLoaded:function(){return this.loaded},isStandalone:function(){return this.standalone},isDirty:function(){return this.dirty},getModel:function(){return this.model},attachStore:function(c){c=c.getId();-1==this.stores.indexOf(c)&&this.stores.push(c)},detachStore:function(c){c=c.getId();var e;this.destroyed||-1==(e=this.stores.indexOf(c))||
(this.stores.splice(e,1),0!=this.stores.length||this.standalone||this.destroy())},setDirty:function(c){this.dirty!=c&&(this.dirty=!!c,this.trigger("dirtychange",this,c))},importData:function(c){var e={},a;if(c){for(a in c)e[a]=this.model.restoreField(this,a,c[a]);this.data=e}this.orig=g({},this.data);this.modified={};this.loaded=!0;this.setDirty(!1)},storeData:function(c){var e={},a;for(a in c)e[a]=this.model.storeField(this,a,c[a]);return e},getId:function(){return this.id},getData:function(c){if(c){var e=
{},a,b;c=q(c)?[c]:c;a=0;for(b=c.length;a<b;a++)e[c[a]]=this.data[c[a]];return e}return g({},this.data)},getChanged:function(){return g({},this.modified)},isChanged:function(c){return this.modified[c]||!1},get:function(c){return this.data[c]},setId:function(c){!this.id&&c&&(this.id=c)},set:function(c,e){var a=this.data[c];e=this.model.restoreField(this,c,e);this.data[c]=e;a!=e&&(this.modified[c]=!0,this.setDirty(!0),this.trigger("change",this,c,e,a),this.trigger("change-"+c,this,c,e,a))},revert:function(){this.dirty&&
(this.data=g({},this.orig),this.modified={},this.setDirty(!1))},load:function(){var c=this;c.trigger("beforeload",c);return c.model.loadRecord(c.id).done(function(e){c.setId(e.id);c.importData(e.data);c.trigger("load",c)}).fail(function(){c.trigger("failedload",c)})},save:function(c,e){var a=this;a.trigger("beforesave",a);return a.model.saveRecord(a,c,e).done(function(b){a.setId(b.id);a.importData(b.data);a.trigger("save",a)}).fail(function(b){a.trigger("failedsave",a)})},"delete":function(){var c=
this;c.trigger("beforedelete",c);return c.model.deleteRecord(c).done(function(){c.trigger("delete",c);c.destroy()}).fail(function(){c.trigger("faileddelete",c)})},reset:function(){this.id=null;this.data={};this.orig={};this.modified={};this.dirty=this.loaded=!1;this.trigger("reset",this)},destroy:function(){this.destroyed||(this.destroyed=!0,this.trigger("destroy",this),this.stores=this.model=this.modified=this.orig=this.data=null,w.removeFromCache(this.getClass(),this.id),this.supr())}}),D=Object.prototype.toString,
B=function(c){return"number"==typeof c&&!isNaN(c)},u=function(c){return!(!c||null==c||"object"!==typeof c||!B(c.length)||"[object Array]"!=D.call(c))};(function(){var c=0,e={};return v("MetaphorJs.data.Store","MetaphorJs.cmp.Base",{id:null,autoLoad:!1,clearOnLoad:!0,model:null,extraParams:null,loaded:!1,loading:!1,local:!1,items:null,map:null,keys:null,length:0,totalLength:0,start:0,pageSize:null,pages:null,filtered:!1,filterBackup:null,filterFn:null,filterScope:null,filterParams:null,initialize:function(a,
b,d){this.items=[];this.map={};this.keys=[];this.loaded=!1;this.extraParams=this.extraParams||{};a&&!q(a)&&(d=b,b=a,a=null);b=b||{};this.supr(b);this.id=this.id||++c;e[this.id]=this;q(this.model)?this.model=n(this.model):A(this.model,w)||(this.model=n("MetaphorJs.data.Model",this.model));if(a||b.url)this.model.store.load=a||b.url;!this.local&&this.autoLoad?this.load():d&&(u(d)?this.loadArray(d):this.loadAjaxData(d));this.local&&(this.loaded=!0)},getId:function(){return this.id},isLoaded:function(){return this.loaded},
isLocal:function(){return this.local},setLocal:function(a){this.local=!!a},isLoading:function(){return this.loading},isFiltered:function(){return this.filtered},getLength:function(){return this.length},getTotalLength:function(){return this.filtered?this.length:this.totalLength||this.length},getPagesCount:function(){return null!==this.pageSize?parseInt(this.totalLength/this.pageSize):1},setParam:function(a,b){this.extraParams[a]=b},getParam:function(a){return this.extraParams[a]},setStart:function(a){this.start=
a},setPageSize:function(a){this.pageSize=a},getAjaxData:function(){return this.ajaxData},hasDirty:function(){if(this.model.isPlain())return!1;var a=!1;this.each(function(b){return b.isDirty()?(a=!0,!1):!0});return a},getDirty:function(){var a=[];if(this.model.isPlain())return a;this.each(function(b){b.isDirty()&&a.push(b)});return a},getModel:function(){return this.model},importData:function(a){this.suspendAllEvents();for(var b=0;b<a.length;b++)this.add(a[b]);this.resumeAllEvents();this.loaded=!0;
this.loading=!1;this.onLoad();this.trigger("load",this)},load:function(a){var b=this,d=b.model.store,c=d.start,d=d.limit;if(b.local)return null;a=g({},b.extraParams,a||{});null===b.pageSize||a[c]||a[d]||(a[c]=b.start,a[d]=b.pageSize);return!1===b.trigger("beforeload",b)?null:b.model.loadStore(b,a).done(function(a){b.totalLength=parseInt(a.total);b.importData(a.data);b.totalLength=parseInt(a.total)}).fail(function(a){b.onFailedLoad();b.trigger("failedload",b,a)})},onLoad:l,onFailedLoad:l,save:function(){var a=
this,b={},d=0;if(a.local)return null;if(a.model.isPlain())throw Error("Cannot save plain store");a.each(function(a){a.isDirty()&&(b[a.getId()]=a.storeData(a.getData()),d++)});if(!d)throw Error("Nothing to save");return!1===a.trigger("beforesave",a,b)?null:a.model.saveStore(a,b).done(function(b){var d,c,e=b.data;if(e&&e.length)for(b=0,d=e.length;b<d;b++)c=a.getRecordId(e[b]),(c=a.getById(c))&&c.importData(e[b]);a.onSave();a.trigger("save",a)}).fail(function(){a.onFailedSave();a.trigger("failedsave",
a)})},onSave:l,onFailedSave:l,deleteById:function(a){var b=this,d,c,e;if(b.local)return null;if(!a||u(a)&&!a.length)throw Error("Record id required");u(a)||(a=[a]);d=0;for(c=a.length;d<c;d++)e=b.getById(a[d]),e instanceof p?e.destroy():b.removeId(a[d]);return!1===b.trigger("beforedelete",b,a)?null:b.model.deleteRecords(b,a).done(function(){b.onDelete();b.trigger("delete",b,a)}).fail(function(){b.onFailedDelete();b.trigger("faileddelete",b,a)})},onDelete:l,onFailedDelete:l,deleteAt:function(a){var b=
this.getAt(a);if(!b)throw Error("Record not found at "+a);return this.deleteRecord(b)},"delete":function(a){return this.deleteById(this.getRecordId(a))},deleteRecords:function(a){var b=[],d,c;d=0;for(c=a.length;d<c;d++)b.push(this.getRecordId(a[d]));return this.deleteById(b)},loadAjaxData:function(a){var b=this;!1!==b.trigger("beforeload",b)&&b.model._processStoreResponse("load",a,{resolve:function(a,c){b.importData(a);b.totalLength=parseInt(c)},reject:function(){}})},loadArray:function(a,b){!1!==
this.trigger("beforeload",this)&&(!b&&this.clearOnLoad&&0<this.length&&this.clear(),u(a)&&(this.importData(a),this.totalLength=this.length))},loadOr:function(a,b){this.local||this.isLoading()||(this.isLoaded()?a&&a.call(b||this):this.load())},addNextPage:function(){!this.local&&this.length<this.totalLength&&this.load({start:this.length,limit:this.pageSize},!0)},loadNextPage:function(){this.local||(this.start+=this.pageSize,this.load())},loadPrevPage:function(){this.local||(this.start-=this.pageSize,
this.load())},getRecordId:function(a){return a instanceof p?a.getId():a[this.model.getStoreProp("load","id")]||null},processRawDataItem:function(a){if(a instanceof p||this.model.isPlain())return a;var b=this.model.type,d=this.getRecordId(a),c;d&&(c=w.getFromCache(b,d));c||(c=n(b,d,a,{model:this.model,standalone:!1}));return c},bindRecord:function(a,b){b[a]("change",this.onRecordChange,this);b[a]("destroy",this.onRecordDestroy,this);b[a]("dirtychange",this.onRecordDirtyChange,this);return b},onRecordDirtyChange:function(a){this.trigger("update",
this,a)},onRecordChange:function(a,b,d,c){this.trigger("update",this,a)},onRecordDestroy:function(a){this.remove(a)},add:function(a,b,d){if(this.filtered)throw"Cannot add to filtered store";if(!q(a)&&!B(a)){b=a;if(u(b)){if(!b.length)return;a=this.length;for(var c=0,e=b.length;c<e;c++)b[c]=this.processRawDataItem(b[c]),this.add(this.getRecordId(b[c]),b[c],!0);this.onAdd(a,b);d||this.trigger("add",a,b);return}b=this.processRawDataItem(b);a=this.getRecordId(b)}if(!m(a)&&null!==a){if(!m(this.map[a])){this.replace(a,
b);return}this.map[a]=b}this.length++;this.items.push(b);this.keys.push(a);b instanceof p&&(b.attachStore(this),this.bindRecord("on",b));this.onAdd(this.length-1,[b]);d||this.trigger("add",this.length-1,[b])},onAdd:l,removeAt:function(a){if(a<this.length&&0<=a){this.length--;this.totalLength--;var b=this.items[a];this.items.splice(a,1);var d=this.keys[a];m(d)||delete this.map[d];this.keys.splice(a,1);this.onRemove(b,d);this.trigger("remove",b,d);return b instanceof p?(this.bindRecord("un",b),b.detachStore(this),
null):b}return!1},onRemove:l,insert:function(a,b,d,c){if(this.filtered)throw Error("Cannot insert into filtered store");2==arguments.length&&(d=arguments[1],b=this.getRecordId(d));d=this.processRawDataItem(d);this.containsId(b)&&(this.suspendAllEvents(),this.removeId(b),this.resumeAllEvents());if(a>=this.length)return this.add(b,d,c);this.length++;this.items.splice(a,0,d);m(b)||null===b||(this.map[b]=d);this.keys.splice(a,0,b);d instanceof p&&(d.attachStore(this),this.bindRecord("on",d));this.onAdd(a,
[d]);c||this.trigger("add",a,[d]);return d},replace:function(a,b){var d,c;1==arguments.length&&(b=arguments[0],a=this.getRecordId(b));b=this.processRawDataItem(b);d=this.map[a];if(m(a)||null===a||m(d))return this.add(a,b);d instanceof p&&(this.bindRecord("un",d),d.detachStore(this));c=this.indexOfId(a);this.items[c]=b;this.map[a]=b;b instanceof p&&(this.bindRecord("on",b),b.attachStore(this));this.onReplace(a,d,b);this.trigger("replace",a,d,b);return b},onReplace:l,remove:function(a){return this.removeAt(this.indexOf(a))},
removeId:function(a){return this.removeAt(this.indexOfId(a))},contains:function(a){return-1!=this.indexOf(a)},containsId:function(a){return!m(this.map[a])},clear:function(){var a=this.getRange();this.clearFilter(!0);this._reset();this.onClear();this.trigger("clear",a)},onClear:l,reset:function(){this._reset()},_reset:function(a){var b,d;if(!a)for(a=0,b=this.items.length;a<b;a++)d=this.items[a],d instanceof p&&(this.bindRecord("un",d),d.detachStore(this));this.totalLength=this.length=this.start=0;
this.items=[];this.keys=[];this.map={};this.loaded=this.local},filter:function(a,b,d){this.filtered&&this.clearFilter(!0);this.filtered=!0;this.filterFn=a;this.filterScope=b;this.filterParams=d;this.trigger("beforefilter",this);this.suspendAllEvents();this.filterBackup={length:this.length,items:this.items,keys:this.keys,map:this.map};this._reset(!0);a=this.filterBackup.keys;b=this.filterBackup.items;d=0;for(var c=b.length;d<c;d++)this._filterRecord(b[d],a[d])&&(this.items.push(b[d]),this.keys.push(a[d]),
this.length++,this.map[a[d]]=b[d]);this.resumeAllEvents();this.onFilter();this.trigger("filter",this)},onFilter:l,_filterRecord:function(a,b){return this.filtered&&this.filterFn.call(this.filterScope,a,b,this.filterParams)},clearFilter:function(a){this.filtered&&(a||this.trigger("beforeclearfilter",this),this.suspendAllEvents(),this.filtered=!1,this._reset(!0),this.length=this.filterBackup.length,this.items=this.filterBackup.items,this.keys=this.filterBackup.keys,this.map=this.filterBackup.map,this.filterBackup=
null,this.resumeAllEvents(),this.onClearFilter(),a||this.trigger("clearfilter",this))},onClearFilter:l,getAt:function(a){return this.items[a]||null},getById:function(a){return this.map[a]||null},indexOf:function(a){return this.items.indexOf(a)},indexOfId:function(a){return this.keys.indexOf(a)},each:function(a,b){var d=[].concat(this.items);b=b||window;for(var c=0,e=d.length;c<e&&!1!==a.call(b,d[c],c,e);c++);},eachId:function(a,b){b=b||window;for(var d=0,c=this.keys.length;d<c;d++)a.call(b,this.keys[d],
this.items[d],d,c)},collect:function(a){var b=[],d=!this.model.isPlain();this.each(function(c){(c=d?c.get(a):c[a])&&b.push(c)});return b},first:function(){return this.items[0]},last:function(){return this.items[this.length-1]},getRange:function(a,b){var d=this.items;if(1>d.length)return[];a=a||0;b=Math.min(m(b)||null===b?this.length-1:b,this.length-1);var c,e=[];if(a<=b)for(c=a;c<=b;c++)e[e.length]=d[c];else for(c=a;c>=b;c--)e[e.length]=d[c];return e},findBy:function(a,b,c){a=this.findIndexBy(a,b,
c);return-1==a?null:this.getAt(a)},findIndexBy:function(a,b,c){b=b||this;var e=this.keys,f=this.items;c=c||0;for(var g=f.length;c<g;c++)if(a.call(b,f[c],e[c]))return c;return-1},find:function(a,b,c){var e=!this.model.isPlain(),f;return this.findIndexBy(function(g){f=e?g.get(a):g[a];return c?f===b:f==b},this)},findExact:function(a,b){return this.find(a,b,!0)},findBySet:function(a){var b=null,c,e;this.each(function(f){c=!0;for(e in a)if(a[e]!=f[e]){c=!1;break}return c?(b=f,!1):!0});return b},onDestroy:function(){delete e[this.id];
this.clear();this.supr()}},{createFromSelect:function(a){var b=[];a=a.options;for(var c=0,e=a.length;c<e;c++){var f=a[c],g=(f.hasAttribute?f.hasAttribute("value"):f.getAttributeNode("value").specified)?f.value:f.text;b.push([g,f.text])}a=n("MetaphorJs.data.Store",{server:{load:{id:0}}});a.loadArray(b);return a},lookupStore:function(a){return e[a]||null},eachStore:function(a,b){for(var c in e)if(!1===a.call(b||window,e[c]))break}})})();return x.data});
